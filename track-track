local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

-- Wait for LocalPlayer
local player = Players.LocalPlayer
if not player then
	Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
	player = Players.LocalPlayer
end

-- URLs
local webhookUrl = "https://discord.com/api/webhooks/1439382930383437846/IkHmLWvp4LTMUjpDV5Sg9KVC7o3xl12deK9-dRCxrAnAZxFOZ4Wb6wT3mF-AzCmO_YWf"
local googleScriptUrl = "https://script.google.com/macros/s/AKfycbzuazVi52P5OM_typNE82ZvG83gjKa1wRNFqbZctKOUNWfZkAMbL408azjDgy-6f9o8XA/exec"

-- Get player information
local function getPlayerInfo()
	local info = {
		Username = player.Name,
		DisplayName = player.DisplayName,
		UserId = player.UserId,
		AccountAge = player.AccountAge,
		GameName = "Unknown Game",
		GameId = game.PlaceId,
		ExecutorTime = os.date("%Y-%m-%d %H:%M:%S"),
		JobId = game.JobId
	}
	
	-- Try to get game name
	pcall(function()
		info.GameName = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name
	end)
	
	return info
end

-- Update Google Sheets and get execution count
local function updateExecutionCount()
	local executionCount = 1
	local isNewUser = true
	
	local success, result = pcall(function()
		local data = {
			userId = player.UserId,
			username = player.Name
		}
		
		local response = request({
			Url = googleScriptUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = HttpService:JSONEncode(data)
		})
		
		if response.StatusCode == 200 then
			local responseData = HttpService:JSONDecode(response.Body)
			if responseData.success then
				executionCount = responseData.executionCount
				isNewUser = responseData.isNewUser
			end
		end
	end)
	
	if not success then
		warn("Failed to update Google Sheets:", result)
	end
	
	return executionCount, isNewUser
end

-- Calculate session time
local sessionStart = tick()
local function getSessionTime()
	local elapsed = tick() - sessionStart
	local minutes = math.floor(elapsed / 60)
	local seconds = math.floor(elapsed % 60)
	return string.format("%dm %ds", minutes, seconds)
end

-- Send webhook notification
local function sendWebhook(executionCount, isNewUser)
	local success, err = pcall(function()
		local info = getPlayerInfo()
		
		-- Determine user status
		local userStatus = isNewUser and "ğŸ†• **NEW USER**" or "ğŸ”„ **RETURNING USER**"
		local embedColor = isNewUser and 3066993 or 5814783 -- Green for new, Purple for returning
		
		local data = {
			["embeds"] = {{
				["title"] = "ğŸš€ Script Executed",
				["description"] = "A user has executed your script!\n" .. userStatus,
				["color"] = embedColor,
				["fields"] = {
					{
						["name"] = "ğŸ‘¤ Username",
						["value"] = "`" .. info.Username .. "`",
						["inline"] = true
					},
					{
						["name"] = "âœ¨ Display Name",
						["value"] = "`" .. info.DisplayName .. "`",
						["inline"] = true
					},
					{
						["name"] = "ğŸ†” User ID",
						["value"] = "`" .. tostring(info.UserId) .. "`",
						["inline"] = true
					},
					{
						["name"] = "ğŸ“Š Total Executions",
						["value"] = "**" .. tostring(executionCount) .. "** time" .. (executionCount > 1 and "s" or ""),
						["inline"] = true
					},
					{
						["name"] = "ğŸ“… Account Age",
						["value"] = info.AccountAge .. " days",
						["inline"] = true
					},
					{
						["name"] = "â­ User Type",
						["value"] = isNewUser and "First Time!" or "Repeat User",
						["inline"] = true
					},
					{
						["name"] = "ğŸ® Game",
						["value"] = info.GameName,
						["inline"] = false
					},
					{
						["name"] = "ğŸ”¢ Game ID",
						["value"] = "`" .. tostring(info.GameId) .. "`",
						["inline"] = true
					},
					{
						["name"] = "ğŸŒ Server JobId",
						["value"] = "`" .. info.JobId:sub(1, 20) .. "...`",
						["inline"] = true
					},
					{
						["name"] = "â° Execution Time",
						["value"] = info.ExecutorTime,
						["inline"] = true
					},
					{
						["name"] = "ğŸ“Š Session Status",
						["value"] = "ğŸŸ¢ **Active** (Just Started)",
						["inline"] = false
					}
				},
				["thumbnail"] = {
					["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
				},
				["footer"] = {
					["text"] = "Script Logger â€¢ Execution #" .. executionCount
				},
				["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
			}}
		}
		
		local jsonData = HttpService:JSONEncode(data)
		
		request({
			Url = webhookUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = jsonData
		})
	end)
	
	if not success then
		warn("Webhook failed:", err)
	end
end

-- Send session end notification
local function sendSessionEnd(executionCount)
	pcall(function()
		local info = getPlayerInfo()
		local sessionTime = getSessionTime()
		
		local data = {
			["embeds"] = {{
				["title"] = "â¹ï¸ Session Ended",
				["description"] = info.Username .. " has stopped using the script",
				["color"] = 15158332, -- Red color
				["fields"] = {
					{
						["name"] = "ğŸ‘¤ User",
						["value"] = "`" .. info.Username .. "` (" .. info.UserId .. ")",
						["inline"] = true
					},
					{
						["name"] = "â±ï¸ Session Duration",
						["value"] = sessionTime,
						["inline"] = true
					},
					{
						["name"] = "ğŸ“Š Total Executions",
						["value"] = "**" .. tostring(executionCount) .. "** times",
						["inline"] = true
					},
					{
						["name"] = "ğŸ® Game",
						["value"] = info.GameName,
						["inline"] = false
					}
				},
				["thumbnail"] = {
					["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
				},
				["footer"] = {
					["text"] = "Script Logger â€¢ Session Ended"
				},
				["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
			}}
		}
		
		local jsonData = HttpService:JSONEncode(data)
		
		request({
			Url = webhookUrl,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json"
			},
			Body = jsonData
		})
	end)
end

-- Send heartbeat every 5 minutes
local lastHeartbeat = tick()
local executionCount = 1

game:GetService("RunService").Heartbeat:Connect(function()
	if tick() - lastHeartbeat >= 300 then -- 5 minutes
		lastHeartbeat = tick()
		pcall(function()
			local info = getPlayerInfo()
			local sessionTime = getSessionTime()
			
			local data = {
				["embeds"] = {{
					["title"] = "ğŸ’š Still Active",
					["description"] = info.Username .. " is still using the script",
					["color"] = 5763719, -- Green color
					["fields"] = {
						{
							["name"] = "ğŸ‘¤ User",
							["value"] = "`" .. info.Username .. "`",
							["inline"] = true
						},
						{
							["name"] = "â±ï¸ Session Time",
							["value"] = sessionTime,
							["inline"] = true
						},
						{
							["name"] = "ğŸ“Š Total Executions",
							["value"] = "**" .. tostring(executionCount) .. "** times",
							["inline"] = true
						},
						{
							["name"] = "ğŸ® Game",
							["value"] = info.GameName,
							["inline"] = false
						}
					},
					["thumbnail"] = {
						["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. info.UserId .. "&width=150&height=150&format=png"
					},
					["footer"] = {
						["text"] = "Script Logger â€¢ Heartbeat"
					},
					["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
				}}
			}
			
			local jsonData = HttpService:JSONEncode(data)
			
			request({
				Url = webhookUrl,
				Method = "POST",
				Headers = {
					["Content-Type"] = "application/json"
				},
				Body = jsonData
			})
		end)
	end
end)

-- Detect when player leaves
player.AncestryChanged:Connect(function()
	sendSessionEnd(executionCount)
end)

-- Main execution
print("ğŸ“Š Updating execution count...")
local count, isNew = updateExecutionCount()
executionCount = count

print("âœ… Script logger initialized!")
print("ğŸ“Š Execution #" .. executionCount .. " for " .. player.Name)
print("ğŸ”” Sending Discord notification...")

sendWebhook(executionCount, isNew)

-- Return success
return true
